<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHADOW SYSTEM - FINAL FIX</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- GI·ªÆ NGUY√äN CSS --- */
        :root {
            --bg-dark: #050810;
            --panel-bg: linear-gradient(160deg, #0b121e 0%, #120c1f 100%);
            --aura-glow: #00a8ff;        
            --shadow-purple: #9d4edd;
            --text-glow: #e0e6ff;
            --danger: #ff3333;
            --warning: #ffcc00;
            --success: #00ff00;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-dark); color: var(--text-glow);
            font-family: 'Roboto Condensed', sans-serif;
            margin: 0; padding: 15px;
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh;
            background-image: linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.85)), url('https://i.pinimg.com/originals/2a/12/35/2a1235476602353195253531353531.jpg');
            background-size: cover; background-attachment: fixed; background-position: center;
            touch-action: manipulation;
        }

        .system-window {
            width: 100%; max-width: 500px;
            background: var(--panel-bg);
            border-radius: 8px; overflow: hidden; position: relative;
            box-shadow: 0 0 20px var(--aura-glow);
            border: 1px solid rgba(0, 168, 255, 0.3);
            animation: slideDown 0.8s ease-out;
            padding-bottom: 30px;
        }

        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .header { background: linear-gradient(90deg, transparent, rgba(0, 86, 179, 0.3), transparent); padding: 20px; text-align: center; border-bottom: 1px solid rgba(0, 168, 255, 0.3); position: relative; }
        .quest-title { color: #fff; font-family: 'Oswald', sans-serif; font-size: 1.8rem; text-transform: uppercase; letter-spacing: 2px; margin: 0; text-shadow: 0 0 15px var(--aura-glow); }
        
        .rank-display { text-align: center; padding: 15px; background: rgba(0,0,0,0.6); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .rank-text { font-size: 1.5rem; color: var(--warning); font-weight: bold; text-shadow: 0 0 10px var(--warning); }
        
        .clock-display { font-family: monospace; color: #888; font-size: 0.9rem; margin-top: 5px; }
        .sim-tag { background: var(--danger); color: #000; padding: 2px 5px; border-radius: 3px; font-weight: bold; font-size: 0.7rem; display:none; margin-left:5px; }

        .content { padding: 15px; max-height: 70vh; overflow-y: auto; }

        .section-title {
            color: var(--aura-glow); border-left: 4px solid var(--shadow-purple); padding-left: 10px; 
            margin: 25px 0 15px 0; font-size: 1.1rem; text-transform: uppercase; font-weight: bold;
            background: linear-gradient(90deg, rgba(0, 86, 179, 0.1), transparent);
        }

        .task-item {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 12px;
            background: rgba(10, 10, 30, 0.6); border: 1px solid rgba(0, 86, 179, 0.3); border-radius: 6px;
            transition: all 0.2s;
        }
        
        button {
            background: rgba(0,0,0,0.5); border: 1px solid var(--aura-glow); color: var(--aura-glow);
            padding: 8px 12px; cursor: pointer; font-family: 'Roboto Condensed', sans-serif; font-weight: bold; border-radius: 4px;
            text-transform: uppercase; font-size: 16px; touch-action: manipulation;
        }
        button:active { background: var(--aura-glow); color: #fff; }
        button.completed { background: var(--shadow-purple); border-color: var(--shadow-purple); color: #fff; pointer-events: none; }
        button:disabled { background: #333; border-color: #555; color: #777; cursor: not-allowed; }

        .gym-list label { display: block; margin-bottom: 8px; cursor: pointer; font-size: 1rem; color: #ccc; }
        .gym-list input { margin-right: 10px; transform: scale(1.3); }
        .progress-text { font-family: monospace; color: #888; font-size: 1rem; }

        /* AI CARD STYLES */
        .ai-card {
            background: linear-gradient(135deg, rgba(13, 17, 23, 0.95), rgba(30, 30, 60, 0.95));
            border: 1px solid var(--shadow-purple);
            padding: 15px; margin-bottom: 15px; border-radius: 8px;
            box-shadow: 0 0 15px rgba(157, 78, 221, 0.2);
            position: relative; overflow: hidden;
        }
        .cycle-badge {
            position: absolute; top: 0; right: 0; background: var(--aura-glow); color: #000;
            padding: 2px 8px; font-size: 0.7rem; font-weight: bold; border-bottom-left-radius: 8px;
        }
        .btn-ai {
            width: 100%; background: linear-gradient(90deg, #4f46e5, #7c3aed); border: none; color: white;
            padding: 12px; margin-top: 10px; display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-scan {
             background: #333; color: #fff; padding: 10px; border: 1px solid #555;
        }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; overflow-y: auto;}
        .modal-content { margin: 5% auto; width: 95%; max-width: 500px; background: #0b121e; border: 2px solid var(--shadow-purple); padding: 20px; border-radius: 10px; position: relative;}
        
        .next-day-btn {
            width: 100%; margin-top: 30px; padding: 15px; font-size: 1rem;
            background: #000; border: 2px solid var(--danger); color: var(--danger);
            font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer; transition: 0.3s;
        }
        .next-day-btn:active { background: var(--danger); color: #000; }
        
        .reward-box { border: 1px solid #555; padding: 20px; margin: 20px 0; background: rgba(255,255,255,0.05); border-radius: 8px;}
        .milestone-text { color: var(--warning); font-size: 1.6rem; text-transform: uppercase; text-shadow: 0 0 15px var(--warning); font-weight: bold; }
        .daily-text { color: var(--aura-glow); font-size: 1.3rem; font-weight: bold; }

        /* CHART & BMI */
        .chart-container { width: 100%; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 10px; margin-bottom: 10px; }
        .bmi-box { background: rgba(0,0,0,0.4); padding: 12px; border-radius: 5px; margin-bottom: 10px; border: 1px solid #333; display: flex; flex-direction: column; gap: 10px; }
        .bmi-row { display: flex; gap: 10px; justify-content: space-between; }
        .bmi-input-wrapper { flex: 1; }
        .bmi-input { background: #111; border: 1px solid #555; color: #fff; padding: 8px; width: 100%; text-align: center; border-radius: 4px; }
        .calc-btn { width: 100%; background: var(--shadow-purple); color: #fff; border: none; padding: 10px; font-weight: bold; margin-top: 5px; }
        .bmi-result-area { border-top: 1px dashed #444; padding-top: 10px; margin-top: 5px; display: none; }
        .analysis-text { font-size: 0.95rem; color: #e0e6ff; line-height: 1.5; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="system-window">
    <div class="header">
        <button onclick="openSettings()" style="position:absolute; left:15px; top:20px; background:none; border:none; color:#555; font-size:1.2rem;"><i class="fas fa-cog"></i></button>
        <h1 class="quest-title">SHADOW SYSTEM</h1>
        <div class="clock-display">
            <span id="real-time-clock">Loading...</span>
            <span id="sim-indicator" class="sim-tag">HACK TIME</span>
        </div>
    </div>

    <div class="rank-display">
        <div id="current-rank" class="rank-text">[RANK F]</div>
        <div style="font-size: 0.9rem; color: #aaa;">Ng√†y th·ª©: <span id="day-streak" style="color:#fff">1</span></div>
        <div id="status-bar" style="margin-top:10px; height:4px; background:#333; border-radius:2px; overflow:hidden;">
            <div id="daily-progress-bar" style="width:0%; height:100%; background:var(--success); transition: width 0.5s;"></div>
        </div>
        <button class="history-btn" onclick="openHistory()">üéí KHO ƒê·ªí & L·ªäCH S·ª¨</button>
    </div>

    <div class="content">
        <!-- DINH D∆Ø·ª†NG (4 m·ª•c) -->
        <div class="section-title">I. DINH D∆Ø·ª†NG</div>
        <div class="task-item"><span>U·ªëng N∆∞·ªõc (6L)</span><div style="display:flex; gap:5px;"><span id="water-val" class="progress-text">0.0</span><button onclick="addWater()">+0.5</button></div></div>
        <div class="task-item"><span>U·ªëng S·ªØa (1L)</span><div style="display:flex; gap:5px;"><span id="milk-val" class="progress-text">0.0</span><button onclick="addMilk()">+0.2</button></div></div>
        <div class="task-item"><span>TP Ch·ª©c NƒÉng (2 l·∫ßn)</span><div style="display:flex; gap:5px;"><span id="supp-val" class="progress-text">0/2</span><button onclick="addSupp()">N·∫†P</button></div></div>
        <div class="task-item"><span>N∆∞·ªõc √©p C√† r·ªët</span><button id="btn-carrot" onclick="toggleTask('carrot')">TH·ª∞C HI·ªÜN</button></div>

        <!-- TH·ªÇ CH·∫§T (2 m·ª•c ch√≠nh) -->
        <div class="section-title">II. R√àN LUY·ªÜN TH·ªÇ CH·∫§T</div>
        
        <!-- AI CYCLE LOGIC -->
        <div class="ai-card">
            <div class="cycle-badge" id="cycle-badge">CHU K·ª≤ 1</div>
            <div style="font-weight:bold; color:#fff; display:flex; align-items:center; gap:8px;">
                <i class="fas fa-brain" style="color:var(--shadow-purple)"></i> GEMINI COACH
            </div>
            
            <div id="goal-section" style="margin-top:10px;">
                <label style="color:#aaa; font-size:0.7rem; text-transform:uppercase;">M·ª•c ti√™u chu k·ª≥ n√†y:</label>
                <div id="locked-goal" style="color:var(--aura-glow); font-style:italic; font-size:0.9rem; padding:5px 0; border-bottom:1px dashed #444; display:none;"></div>
                <input type="text" id="input-goal" style="width:100%; background:#111; border:1px solid #444; color:white; padding:8px; margin-top:5px; border-radius:4px; display:none;" placeholder="VD: Vai to h∆°n, Gi·∫£m m·ª°...">
            </div>

            <div id="upload-status-area" style="margin-top:15px; text-align:center;">
                <div id="checked-in-msg" style="display:none; color:var(--success); font-weight:bold; border:1px solid var(--success); padding:10px; border-radius:5px; background:rgba(0,255,0,0.1);">
                    <i class="fas fa-check-circle"></i> ƒê√É CHECK-IN H√îM NAY
                </div>
                
                <button id="btn-daily-upload" onclick="triggerUpload()" class="btn-ai" style="background:#333; border:1px dashed #666; display:none;">
                    <i class="fas fa-camera"></i> N·ªòP ·∫¢NH BODY H√îM NAY
                </button>
                <input type="file" id="daily-file" accept="image/*" style="display:none" onchange="handleDailyUpload(event)">
            </div>

            <button id="btn-analyze-cycle" onclick="runCycleAnalysis()" class="btn-ai" style="display:none; margin-top:15px; animation: pulse 2s infinite;">
                <i class="fas fa-bolt"></i> PH√ÇN T√çCH CHU K·ª≤ (NG√ÄY <span id="cycle-day-idx">3</span>)
            </button>
            <div id="ai-loading" style="display:none; text-align:center; color:var(--aura-glow); margin-top:10px;">ƒêang tri·ªáu h·ªìi AI...</div>
        </div>

        <div class="task-item" style="flex-direction:column; align-items:flex-start;">
            <div style="font-weight:bold; color:var(--aura-glow); margin-bottom:5px;">BMI & C√ÇN N·∫∂NG</div>
            <div class="bmi-box" style="width:100%;">
                <div class="bmi-row">
                    <div class="bmi-input-wrapper"><input type="number" id="height-input" class="bmi-input" placeholder="Cao (cm)"></div>
                    <div class="bmi-input-wrapper"><input type="number" id="weight-input" class="bmi-input" placeholder="N·∫∑ng (kg)"></div>
                    <div class="bmi-input-wrapper"><input type="number" id="target-bmi-input" class="bmi-input" placeholder="BMI Goal"></div>
                </div>
                <button id="btn-calc-bmi" class="calc-btn" onclick="calculateBMI()">T√çNH TO√ÅN & L∆ØU</button>
                <div id="bmi-result-area" class="bmi-result-area">
                    <div class="analysis-text">BMI: <span id="bmi-val" class="hl">--</span> (<span id="bmi-status">--</span>)</div>
                    <div id="bmi-advice" class="analysis-text" style="margin-top:5px; border-top:1px solid #333; padding-top:5px;"></div>
                </div>
            </div>
        </div>

        <!-- GYM SCHEDULE (1 m·ª•c) -->
        <div class="task-item" style="flex-direction:column; align-items:flex-start;">
            <div style="font-weight:bold; color:var(--aura-glow); margin-bottom:10px;">L·ªäCH T·∫¨P GYM</div>
            <div id="gym-block" style="width:100%; display:none;">
                <div class="schedule-info">TH·ª® 2,3,4,6,7: T·∫¨P GYM</div>
                <div class="gym-list">
                    <label><input type="checkbox" onchange="checkGym()" class="gym-check"> 50 Bicep Curls</label>
                    <label><input type="checkbox" onchange="checkGym()" class="gym-check"> 25 Tricep Dips</label>
                    <label><input type="checkbox" onchange="checkGym()" class="gym-check"> 50 Squats</label>
                    <label><input type="checkbox" onchange="checkGym()" class="gym-check"> 25 Incline Press</label>
                    <label><input type="checkbox" onchange="checkGym()" class="gym-check"> 25 Lunges</label>
                </div>
                <div id="gym-status" style="width:100%; text-align:right; font-size:0.9rem; color:#666; margin-top:5px;">CH∆ØA XONG</div>
            </div>
            <div id="sprint-block" style="width:100%; display:none;">
                <div class="schedule-info">TH·ª® 5, CN: CH·∫†Y N∆Ø·ªöC R√öT</div>
                <button id="btn-sprint" style="width:100%; margin-top:10px;" onclick="toggleTask('sprint')">TH·ª∞C HI·ªÜN</button>
            </div>
            <div id="rest-msg" class="rest-day-text" style="display:none;">H√îM NAY NGH·ªà NG∆†I HO√ÄN TO√ÄN</div>
        </div>

        <div class="task-item"><span>ƒê·∫°p xe m·ªói ng√†y</span><button id="btn-bike" onclick="toggleTask('bike')">TH·ª∞C HI·ªÜN</button></div>

        <!-- NGO·∫†I H√åNH (4 m·ª•c) -->
        <div class="section-title">III. NGO·∫†I H√åNH</div>
        <div class="task-item"><span>Skincare (2 l·∫ßn)</span> <button id="btn-skin" onclick="toggleTask('skin')">XONG</button></div>
        <div class="task-item"><span>Jawline/Mewing</span> <button id="btn-jaw" onclick="toggleTask('jaw')">T·∫¨P</button></div>
        <div class="task-item"><span>Mewing (Gi·ªØ l∆∞·ª°i)</span> <button id="btn-mewing" onclick="toggleTask('mewing')">TH·ª∞C HI·ªÜN</button></div>
        <div class="task-item"><span>T·∫≠p M≈©i (3 l·∫ßn)</span> <button id="btn-nose" onclick="toggleTask('nose')">T·∫¨P</button></div>
        
        <!-- TRI TH·ª®C (2 m·ª•c) -->
        <div class="section-title">IV. TRI TH·ª®C</div>
        <div class="task-item"><span>H·ªçc Ti·∫øng Nh·∫≠t</span> <button id="btn-jp" onclick="toggleTask('jp')">TH·ª∞C HI·ªÜN</button></div>
        <div class="task-item"><span>H·ªçc Ph·ªï Th√¥ng</span> <button id="btn-school" onclick="toggleTask('school')">TH·ª∞C HI·ªÜN</button></div>

        <button class="next-day-btn" onclick="forceNextDay()">>> HACK: QUA NG√ÄY TI·∫æP THEO >></button>
    </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settings-modal" class="modal">
    <div class="modal-content" style="text-align:left;">
        <h2 style="color:white; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:5px;">C·∫§U H√åNH AI</h2>
        <label style="color:#aaa; font-size:0.9rem;">1. Gemini API Key</label>
        <div style="display:flex; gap:5px;">
            <input type="password" id="api-key-input" style="flex:1; padding:10px; background:#111; border:1px solid #555; color:white; border-radius:5px;" placeholder="D√°n API Key...">
            <button onclick="scanModels()" class="btn-scan"><i class="fas fa-search"></i> SCAN</button>
        </div>
        <label style="color:#aaa; font-size:0.9rem; margin-top:15px; display:block;">2. Ch·ªçn Model (C·∫ßn Scan tr∆∞·ªõc)</label>
        <select id="model-select" style="width:100%; padding:10px; background:#111; color:white; border:1px solid #555; margin-top:5px; border-radius:5px;">
            <option value="gemini-1.5-flash">Gemini 1.5 Flash (Default)</option>
        </select>
        <button onclick="saveSettings()" style="width:100%; background:var(--aura-glow); color:black; margin-top:20px; font-weight:bold; padding:12px; border:none; border-radius:5px;">L∆ØU C·∫§U H√åNH</button>
        <button onclick="document.getElementById('settings-modal').style.display='none'" style="width:100%; margin-top:10px; background:none; border:none; color:#aaa;">ƒê√ìNG</button>
    </div>
</div>

<!-- RESULT MODAL -->
<div id="result-modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3 style="color:var(--success); margin:0;">K·∫æT QU·∫¢ PH√ÇN T√çCH</h3>
            <button onclick="document.getElementById('result-modal').style.display='none'" style="background:none; border:none; color:#fff;"><i class="fas fa-times"></i></button>
        </div>
        <div id="chart-wrapper" class="chart-container"></div>
        <div style="text-align:left; background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;">
            <div style="font-size:1.5rem; font-weight:bold; color:var(--success); text-align:center; margin-bottom:10px;" id="res-score">--</div>
            <div id="res-trend" style="font-style:italic; color:#fff; border-left:3px solid var(--aura-glow); padding-left:10px; margin-bottom:15px;"></div>
            <div style="color:var(--danger); font-weight:bold; font-size:0.9rem;">‚ö†Ô∏è KHUY·∫æT ƒêI·ªÇM:</div><p id="res-weak" style="color:#ccc; font-size:0.9rem; margin-top:2px;"></p>
            <div style="color:var(--success); font-weight:bold; font-size:0.9rem; margin-top:10px;">‚úÖ C·∫¢I THI·ªÜN:</div><p id="res-imp" style="color:#ccc; font-size:0.9rem; margin-top:2px;"></p>
            <div style="margin-top:15px; border-top:1px solid #333; padding-top:10px;"><div style="font-weight:bold; color:#818cf8;">K·∫æ HO·∫†CH T·∫¨P</div><ul id="res-ex" style="padding-left:20px; color:#ddd; font-size:0.9rem;"></ul></div>
            <div style="margin-top:10px;"><div style="font-weight:bold; color:#fb923c;">DINH D∆Ø·ª†NG</div><ul id="res-nut" style="padding-left:20px; color:#ddd; font-size:0.9rem;"></ul></div>
        </div>
    </div>
</div>

<!-- REWARD MODAL -->
<div id="reward-modal" class="modal"><div class="modal-content"><h2 style="color:var(--success)">HO√ÄN TH√ÄNH</h2><div id="reward-display" class="reward-box"></div><button onclick="document.getElementById('reward-modal').style.display='none'" style="background:var(--warning); color:#000; border:none; padding:12px 25px; font-weight:bold;">NH·∫¨N</button></div></div>

<!-- HISTORY MODAL -->
<div id="history-modal" class="modal"><div class="modal-content"><h2 style="color:var(--aura-glow)">KHO ƒê·ªí</h2><div id="history-content" style="text-align:left; max-height:300px; overflow-y:auto; margin-top:10px;"></div><button onclick="document.getElementById('history-modal').style.display='none'" style="width:100%; margin-top:15px; border:1px solid var(--danger); background:none; color:var(--danger); padding:10px;">ƒê√ìNG</button></div></div>

<script>
    // --- GLOBAL CONSTANTS ---
    const BASE_URL = "https://generativelanguage.googleapis.com/v1beta";
    const DB_KEY = 'shadowV_Fixed_Final'; 
    const ranks = [{day:0,title:"K·∫ª V√¥ Danh"},{day:3,title:"[F] Th·ª©c T·ªânh"},{day:7,title:"[E] T√¢n Binh"},{day:14,title:"[D] Chi·∫øn Binh"},{day:21,title:"[C] Ki·∫øn Tr√∫c S∆∞"},{day:28,title:"[B] Hi·ªáp Sƒ©"},{day:35,title:"[A] Th·ª£ SƒÉn"},{day:100,title:"[EX] Th·∫ßn Ch·ªß"}];
    const dailyPool = ["Ch∆°i Game 30p","Ng·ªß tr∆∞a","D·∫°o ph·ªë","ƒÇn V·∫∑t","L∆∞·ªõt FB 30p","Xem Anime","Xem Phim","Nghe nh·∫°c 1h","Mua ƒë·ªì <50k"];
    const milestones = { 3: "1 tr·∫≠n LoL üéÆ", 7: "Cheat Meal üçî", 10: "Mua 1 quy·ªÉn s√°ch üìö", 14: "Mua 1 b·ªô Board Game üé≤", 17: "G·∫≠y T√¥n Ng·ªô Kh√¥ng ü•¢", 21: "L√†m Beef Wellington ü•©", 24: "Nu√¥i Th√∫ C∆∞ng üê∂", 28: "Ki·∫øm B·∫°n G√°i üíò", 33: "Gi√†y Jimmy Butler üëü" };

    // --- STATE MANAGEMENT ---
    let data = {
        day: 1, lastDate: new Date().toDateString(), offsetDays: 0,
        water: 0, milk: 0, supp: 0, tasks: {}, gymDone: false, rewardClaimed: false,
        height: '', weightHistory: [], targetBMI: '', history: [],
        apiKey: '', modelName: 'gemini-1.5-flash', goals: {}, photos: [], scoreHistory: [] 
    };

    // --- TIME & INIT LOGIC ---
    function getEffectiveDate() { const d = new Date(); d.setDate(d.getDate() + (data.offsetDays || 0)); return d; }

    function init() {
        const saved = localStorage.getItem(DB_KEY);
        if(saved) data = { ...data, ...JSON.parse(saved) };
        
        // Ki·ªÉm tra ng√†y m·ªõi NGAY L·∫¨P T·ª®C khi m·ªü app
        const todayStr = getEffectiveDate().toDateString();
        if (data.lastDate !== todayStr) {
            triggerNewDay(todayStr, false); // false = kh√¥ng alert
        }

        renderUI(); 
        loadBMIState();
        document.getElementById('api-key-input').value = data.apiKey || "";
        
        setInterval(() => {
            const now = getEffectiveDate();
            document.getElementById('real-time-clock').innerText = now.toLocaleDateString('vi-VN', {weekday:'short', hour:'2-digit', minute:'2-digit'});
            if(data.offsetDays > 0) { 
                document.getElementById('sim-indicator').style.display = 'inline-block'; 
                document.getElementById('sim-indicator').innerText = `+${data.offsetDays} NG√ÄY`; 
            }
            // Auto check n·ª≠a ƒë√™m
            if(now.getHours()===0 && now.getMinutes()===0 && now.getSeconds()===0) {
                if (data.lastDate !== now.toDateString()) triggerNewDay(now.toDateString(), true);
            }
        }, 1000);
    }

    // --- HACK TIME LOGIC (FIXED) ---
    function forceNextDay() { 
        if(confirm("X√ÅC NH·∫¨N: B·ªè qua ng√†y h√¥m nay?")) { 
            // 1. TƒÉng ng√†y ·∫£o
            data.offsetDays = (data.offsetDays || 0) + 1;
            // 2. G·ªçi logic ng√†y m·ªõi
            triggerNewDay(getEffectiveDate().toDateString(), true);
        } 
    }
    
    function triggerNewDay(dateStr, showAlert) { 
        // Logic Reset ng√†y
        data.day++; 
        data.water = 0; data.milk = 0; data.supp = 0; 
        data.tasks = {}; data.gymDone = false; data.rewardClaimed = false;
        data.lastDate = dateStr; 
        
        unlockBMI(); // Reset BMI input
        save(); 
        renderUI(); // Render l·∫°i ngay l·∫≠p t·ª©c
        if(showAlert) alert("ƒê√É QUA NG√ÄY M·ªöI! CH√ÄO M·ª™NG NG√ÄY TH·ª® " + data.day); 
    }

    // --- PROGRESS LOGIC (FIXED COUNT) ---
    function checkProgress() {
        let completed = 0;
        let total = 12; // C·ªë ƒë·ªãnh t·ªïng s·ªë nhi·ªám v·ª• ƒë·ªÉ ƒë·∫£m b·∫£o thanh ƒë·∫ßy
        
        /* LIST NHI·ªÜM V·ª§ (T·ªïng 12 ƒëi·ªÉm):
           1. Water
           2. Milk
           3. Supp
           4. Carrot
           5. Gym/Sprint/Rest (T√≠nh l√† 1 m·ª•c Th·ªÉ Ch·∫•t)
           6. Bike
           7. Skin
           8. Jaw
           9. Mewing
           10. Nose
           11. JP
           12. School
        */

        if(data.water >= 6) completed++;
        if(data.milk >= 1) completed++;
        if(data.supp >= 2) completed++;
        
        ['carrot','bike','sprint','skin','jaw','mewing','nose','jp','school'].forEach(k => {
            if(data.tasks[k]) completed++;
        });

        // X·ª≠ l√Ω Gym/Sprint/Rest
        const dayIdx = getEffectiveDate().getDay();
        // N·∫øu l√† ng√†y t·∫≠p Gym (T2,3,4,6,7) -> Check gymDone
        if([1,2,3,5,6].includes(dayIdx)) {
            if(data.gymDone) completed++;
        }
        // N·∫øu l√† ng√†y Sprint (CN, T5) -> Check task sprint
        else if([0,4].includes(dayIdx)) {
            if(data.tasks.sprint) {
                // ƒê√£ c·ªông ·ªü v√≤ng l·∫∑p forEach tr√™n r·ªìi, kh√¥ng c·ªông l·∫°i
            }
        }
        // N·∫øu l√† ng√†y Rest (kh√¥ng c√≥ Gym/Sprint) -> T·ª± ƒë·ªông t·∫∑ng 1 ƒëi·ªÉm
        else {
            completed++; 
        }

        // Fix tr√†n thanh
        if (completed > total) completed = total;

        let pct = (completed / total) * 100;
        document.getElementById('daily-progress-bar').style.width = pct + "%";
        
        // Trigger qu√†
        if(pct >= 100 && !data.rewardClaimed) triggerReward();
    }

    // --- RENDER UI ---
    function renderUI() {
        document.getElementById('day-streak').innerText = data.day;
        let rTitle = ranks[0].title; for(let r of ranks) if(data.day >= r.day) rTitle = r.title;
        document.getElementById('current-rank').innerText = rTitle;
        document.getElementById('water-val').innerText = data.water.toFixed(1) + "/6";
        document.getElementById('milk-val').innerText = data.milk.toFixed(1) + "/1";
        document.getElementById('supp-val').innerText = data.supp + "/2";
        
        // Buttons Update
        ['carrot','bike','sprint','skin','jaw','mewing','jp','school','nose'].forEach(k => {
            const b = document.getElementById('btn-'+k);
            if(b) {
                if(data.tasks[k]) { b.classList.add('completed'); b.innerText = "XONG"; } 
                else { b.classList.remove('completed'); b.innerText = "TH·ª∞C HI·ªÜN"; }
            }
        });

        // Gym Schedule Update
        const dayIdx=getEffectiveDate().getDay();
        const gym=document.getElementById('gym-block'); const sprint=document.getElementById('sprint-block'); const rest=document.getElementById('rest-msg');
        
        // ·∫®n t·∫•t c·∫£ tr∆∞·ªõc
        gym.style.display='none'; sprint.style.display='none'; rest.style.display='none';

        if([1,2,3,5,6].includes(dayIdx)) { gym.style.display='block'; }
        else if([0,4].includes(dayIdx)) { sprint.style.display='block'; }
        else { rest.style.display='block'; } // Tr∆∞·ªùng h·ª£p c√≤n l·∫°i (n·∫øu c√≥)
        
        // Gym Status
        const gymStatus = document.getElementById('gym-status');
        const checkboxes = document.querySelectorAll('.gym-check');
        if(data.gymDone) { 
            gymStatus.innerText = "HO√ÄN TH√ÄNH"; 
            gymStatus.style.color = "#00ff00"; 
            checkboxes.forEach(c => c.checked = true); 
        } else { 
            gymStatus.innerText = "CH∆ØA XONG"; 
            gymStatus.style.color = "#666"; 
            checkboxes.forEach(c => c.checked = false);
        }

        checkProgress(); // Recalc progress bar immediately

        // AI Logic
        const currentCycle = Math.ceil(data.day / 3);
        const cycleDayIdx = (data.day - 1) % 3 + 1;
        document.getElementById('cycle-badge').innerText = `CHU K·ª≤ ${currentCycle} - NG√ÄY ${cycleDayIdx}/3`;

        const savedGoal = data.goals[currentCycle];
        const goalInput = document.getElementById('input-goal');
        const lockedGoal = document.getElementById('locked-goal');
        
        if (cycleDayIdx === 1 && !savedGoal) {
            goalInput.style.display = 'block'; lockedGoal.style.display = 'none';
        } else {
            goalInput.style.display = 'none'; lockedGoal.style.display = 'block';
            lockedGoal.innerText = savedGoal || "(Ch∆∞a ƒë·∫∑t m·ª•c ti√™u)";
        }

        const hasPhotoToday = data.photos.some(p => p.day === data.day);
        const btnUpload = document.getElementById('btn-daily-upload');
        const msgChecked = document.getElementById('checked-in-msg');
        
        if(hasPhotoToday) { btnUpload.style.display = 'none'; msgChecked.style.display = 'block'; } 
        else { btnUpload.style.display = 'flex'; msgChecked.style.display = 'none'; }

        const btnAnalyze = document.getElementById('btn-analyze-cycle');
        document.getElementById('cycle-day-idx').innerText = data.day; 
        
        if (cycleDayIdx === 3 && hasPhotoToday) { btnAnalyze.style.display = 'flex'; } 
        else { btnAnalyze.style.display = 'none'; }
    }

    // --- ACTIONS ---
    function addWater() { if(data.water < 6) { data.water += 0.5; save(); } }
    function addMilk() { if(data.milk < 1) { data.milk += 0.2; save(); } }
    function addSupp() { if(data.supp < 2) { data.supp++; save(); } }
    function toggleTask(k) { data.tasks[k] = !data.tasks[k]; save(); }
    function checkGym() { if(document.querySelectorAll('.gym-check:checked').length === 5) data.gymDone = true; else data.gymDone = false; save(); }
    
    function triggerReward() {
        data.rewardClaimed = true;
        let n = "", h = "";
        if(milestones[data.day]) { n = milestones[data.day]; h = `<div style="color:#aaa;">M·ªêC QUAN TR·ªåNG</div><div class="milestone-text">${n}</div>`; }
        else { n = dailyPool[Math.floor(Math.random() * dailyPool.length)]; h = `<div style="color:#aaa;">PH·∫¶N TH∆Ø·ªûNG NG·∫™U NHI√äN</div><div class="daily-text">üéÅ ${n}</div>`; }
        data.history.push({ day: data.day, item: n, date: getEffectiveDate().toLocaleDateString('vi-VN') });
        save(); document.getElementById('reward-display').innerHTML = h; document.getElementById('reward-modal').style.display = 'block';
    }

    // --- OTHER LOGIC (AI, BMI...) KEPT SAME ---
    function save() { localStorage.setItem(DB_KEY, JSON.stringify(data)); renderUI(); }
    function openSettings() { document.getElementById('settings-modal').style.display='block'; }
    function closeReward() { document.getElementById('reward-modal').style.display = 'none'; }
    function openHistory() {
        const c = document.getElementById('history-content'); c.innerHTML = "";
        [...data.history].reverse().forEach(h => c.innerHTML += `<div style="padding:10px; border-bottom:1px solid #333;"><b style="color:#f0ad4e">Ng√†y ${h.day}</b>: ${h.item}</div>`);
        document.getElementById('history-modal').style.display='block';
    }

    // --- BMI ---
    function loadBMIState() {
        if(data.height) document.getElementById('height-input').value=data.height;
        if(data.targetBMI) document.getElementById('target-bmi-input').value=data.targetBMI;
        const todayEntry = data.weightHistory.find(item => item.day === data.day);
        if(todayEntry) { 
            document.getElementById('weight-input').value = todayEntry.weight; 
            showBMIResult(todayEntry.height, todayEntry.weight, data.targetBMI, todayEntry.compare); lockBMI(); 
        } else unlockBMI();
    }
    function calculateBMI() {
        const h = parseFloat(document.getElementById('height-input').value);
        const w = parseFloat(document.getElementById('weight-input').value);
        const t = parseFloat(document.getElementById('target-bmi-input').value);
        if(!h || !w || !t) { alert("Nh·∫≠p ƒë·ªß!"); return; }
        data.height = h; data.targetBMI = t;
        let compareText = "D·ªØ li·ªáu kh·ªüi ƒëi·ªÉm.";
        if(data.weightHistory.length > 0) {
            const prev = [...data.weightHistory].reverse().find(x => x.day !== data.day);
            if(prev) { const dW = (w - prev.weight).toFixed(1); compareText = (dW>0 ? `‚ñ≤ TƒÉng ${dW}kg` : (dW<0 ? `‚ñº Gi·∫£m ${Math.abs(dW)}kg` : "Gi·ªØ c√¢n")) + ` so v·ªõi Ng√†y ${prev.day}`; }
        }
        const idx = data.weightHistory.findIndex(x => x.day === data.day);
        const entry = { day: data.day, date: getEffectiveDate().toLocaleDateString('vi-VN'), weight: w, height: h, compare: compareText };
        if(idx >= 0) data.weightHistory[idx] = entry; else data.weightHistory.push(entry);
        save(); showBMIResult(h, w, t, compareText); lockBMI();
    }
    function showBMIResult(h, w, t, comp) {
        const hM = h / 100; const bmi = (w / (hM * hM)).toFixed(1);
        document.getElementById('bmi-result-area').style.display = 'block';
        document.getElementById('bmi-val').innerText = bmi; 
        document.getElementById('bmi-status').innerText = (bmi < 18.5 ? "G·∫ßy" : (bmi < 24.9 ? "Chu·∫©n" : "Th·ª´a"));
        document.getElementById('bmi-advice').innerHTML = `M·ª§C TI√äU BMI ${t}: ` + ((w - t*hM*hM) > 0 ? `Gi·∫£m ${((w - t*hM*hM)).toFixed(1)}kg` : `TƒÉng ${Math.abs((w - t*hM*hM)).toFixed(1)}kg`);
    }
    function lockBMI() { document.getElementById('btn-calc-bmi').innerText = "ƒê√É CH·ªêT"; document.getElementById('btn-calc-bmi').disabled = true; }
    function unlockBMI() { document.getElementById('btn-calc-bmi').innerText = "T√çNH TO√ÅN"; document.getElementById('btn-calc-bmi').disabled = false; document.getElementById('weight-input').value = ""; document.getElementById('bmi-result-area').style.display = 'none'; }

    // --- AI FUNCTIONS ---
    async function scanModels() {
        const key = document.getElementById('api-key-input').value.trim();
        if(key.length < 10) return alert("Key qu√° ng·∫Øn!");
        const btn = document.querySelector('.btn-scan'); btn.innerText = "...";
        try {
            const res = await fetch(`${BASE_URL}/models?key=${key}`);
            const json = await res.json();
            const models = json.models.filter(m => m.supportedGenerationMethods.includes("generateContent") && (m.name.includes("flash") || m.name.includes("pro"))).map(m => m.name.replace("models/", ""));
            const sel = document.getElementById('model-select'); sel.innerHTML = "";
            models.forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.innerText = m; sel.appendChild(opt); });
            alert(`T√¨m th·∫•y ${models.length} model!`);
        } catch(e) { alert("L·ªói: " + e.message); } finally { btn.innerHTML = '<i class="fas fa-search"></i> SCAN'; }
    }
    function saveSettings() {
        data.apiKey = document.getElementById('api-key-input').value.trim();
        data.modelName = document.getElementById('model-select').value;
        save(); document.getElementById('settings-modal').style.display='none';
    }
    function triggerUpload() {
        const currentCycle = Math.ceil(data.day / 3);
        const cycleDayIdx = (data.day - 1) % 3 + 1;
        if(cycleDayIdx === 1) {
             const g = document.getElementById('input-goal').value.trim();
             if(!g && !data.goals[currentCycle]) return alert("H√£y nh·∫≠p m·ª•c ti√™u tr∆∞·ªõc!");
             if(g) data.goals[currentCycle] = g;
        }
        document.getElementById('daily-file').click();
    }
    function handleDailyUpload(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            const img = new Image();
            img.onload = function() {
                const cvs = document.createElement('canvas');
                let w = img.width, h = img.height;
                if(w>800) { h *= 800/w; w=800; }
                cvs.width=w; cvs.height=h;
                cvs.getContext('2d').drawImage(img,0,0,w,h);
                const base64 = cvs.toDataURL('image/jpeg', 0.6);
                const currentCycle = Math.ceil(data.day / 3);
                data.photos.push({ day: data.day, url: base64, cycle: currentCycle });
                save(); alert("ƒê√£ Check-in!");
            }
            img.src = evt.target.result;
        }
        reader.readAsDataURL(file);
    }
    async function runCycleAnalysis() {
        if(!data.apiKey) return alert("Ch∆∞a nh·∫≠p Key!");
        const currentCycle = Math.ceil(data.day / 3);
        const goal = data.goals[currentCycle] || "Fit body";
        const startDay = data.day - 2;
        const endDay = data.day;
        const firstPhoto = data.photos.find(p => p.day === startDay);
        const lastPhoto = data.photos.find(p => p.day === endDay);
        
        if(!firstPhoto || !lastPhoto) return alert("Thi·∫øu ·∫£nh ƒë·∫ßu ho·∫∑c cu·ªëi chu k·ª≥!");
        
        document.getElementById('btn-analyze-cycle').style.display = 'none';
        document.getElementById('ai-loading').style.display = 'block';

        const prompt = `Vai tr√≤: Coach. So s√°nh ·∫£nh Ng√†y ${startDay} & ${endDay}. M·ª•c ti√™u: "${goal}". Output JSON: {"score":(0-100), "trend":"...", "weakness":"...", "improvement":"...", "plan_ex":["..."], "plan_nut":["..."]}`;
        const clean64 = (u) => u.split(',')[1];
        const payload = {
            contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: clean64(firstPhoto.url) } }, { inline_data: { mime_type: "image/jpeg", data: clean64(lastPhoto.url) } }] }],
            generationConfig: { responseMimeType: "application/json" }
        };

        try {
            const res = await fetch(`${BASE_URL}/models/${data.modelName}:generateContent?key=${data.apiKey}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            const json = await res.json();
            const result = JSON.parse(json.candidates[0].content.parts[0].text);
            data.scoreHistory.push(result.score); save();
            
            document.getElementById('res-score').innerText = result.score + "/100";
            document.getElementById('res-trend').innerText = result.trend;
            document.getElementById('res-weak').innerText = result.weakness;
            document.getElementById('res-imp').innerText = result.improvement;
            document.getElementById('res-ex').innerHTML = result.plan_ex.map(i=>`<li>${i}</li>`).join('');
            document.getElementById('res-nut').innerHTML = result.plan_nut.map(i=>`<li>${i}</li>`).join('');
            renderChart(data.scoreHistory);
            document.getElementById('result-modal').style.display = 'block';
        } catch(e) { alert("L·ªói AI: " + e.message); } 
        finally { document.getElementById('ai-loading').style.display = 'none'; }
    }
    function renderChart(scores) {
        if(scores.length < 2) return document.getElementById('chart-wrapper').innerHTML = "Ch∆∞a ƒë·ªß d·ªØ li·ªáu";
        const w=300, h=100, max=100;
        const pts = scores.map((s,i) => `${(i/(scores.length-1))*w},${h-(s/max)*h}`).join(' ');
        const dots = scores.map((s,i) => `<circle cx="${(i/(scores.length-1))*w}" cy="${h-(s/max)*h}" r="4" fill="#4f46e5" stroke="white"/>`).join('');
        document.getElementById('chart-wrapper').innerHTML = `<svg viewBox="0 0 ${w} ${h}" style="width:100%; height:100px; overflow:visible;"><polyline fill="none" stroke="#4f46e5" stroke-width="3" points="${pts}"/>${dots}</svg>`;
    }

    init();
</script>
</body>
</html>
